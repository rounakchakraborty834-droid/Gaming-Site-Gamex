var e=Object.defineProperty,t=(t,s,o)=>(((t,s,o)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o})(t,"symbol"!=typeof s?s+"":s,o),o);import{c as s,G as o,g as r,a,b as n,d as l,e as i,l as d,f as c,h as p,i as h,L as u,j as L}from"./loader-globals.d8a67046.js";import{e as g}from"./index.77e4f8bb.js";const f=n({renderer:null,ktxTranscoderPath:null,useKTX:!0}),x=(e,t)=>{const n=f(t);return s(e,"gltf",n,(e=>{let t;const s=new o,l=n.renderer||r().GLOBAL_RENDERER;if(l&&n.useKTX)try{const e=a(n.ktxTranscoderPath,l);s.setKTX2Loader(e)}catch(i){}return{load:o=>new Promise(((r,a)=>{s.load(e,(e=>{t=e,r(t)}),(e=>{var t;const s=e.loaded/e.total;null===(t=null==o?void 0:o.onProgress)||void 0===t||t.call(o,s)}),(e=>{a(e)}))})),cancel(){},dispose(){},data:()=>t}}))},O=(e,t)=>{const s=e.split("#");if(2===s.length)return{url:s[0],type:s[1]};{const o=e.split("."),r=o[o.length-1];let a;const n=Object.entries(t);for(let e=0;e<n.length&&void 0===a;e++){const[t,s]=n[e];s.extType.indexOf(`.${r}`)>=0&&(a=t)}return{url:s[0],type:a}}},m=(e,t=(()=>({json:{loader:l,extType:[".json"]},image:{loader:i,extType:[".jpg",".jpeg",".png",".avif",".webp"]},texture:{loader:d,extType:[".jpg",".jpeg",".png",".avif",".webp"]},spritesheet:{loader:c,extType:[".json"]},gltf:{loader:x,extType:[".gltf",".glb"]},ktx:{loader:p,extType:[".ktx2",".ktx"]}}))(),s={})=>{const o=e.map((e=>((e,t={})=>{if(null==e)return null;if("string"==typeof e){const{type:s,url:o}=O(e,t),r=t[s];if(r)return r.loader(o)}else if(e instanceof Array&&2===e.length){const{type:s,url:o}=O(e[0],t),r=t[s],a=e[1];if(r)return r.loader(o,a)}throw new Error("Invalid type or url when resolving loader.")})(e,t))).filter((e=>null!==e));return h(o,s)};class y extends g{constructor(){super(...arguments),t(this,"loaders",[]),t(this,"expectedLoaders",[]),t(this,"complete",!1),t(this,"onLoaderComplete",(()=>{const e=this.loaders.reduce(((e,t)=>t.state===L.COMPLETE?e+1:e),0);setTimeout((()=>{e>=this.loaders.length&&!this.complete&&(this.complete=!0,this.emit(u.LOAD_COMPLETE))}),100)}))}reset(){this.complete=!1}expectLoader(e){this.expectedLoaders.indexOf(e)&&this.expectedLoaders.push(e)}unexpectLoader(e){const t=this.expectedLoaders.indexOf(e);t>-1&&this.expectedLoaders.splice(t,1)}registerLoader(e,t=""){-1===this.loaders.indexOf(e)&&(this.loaders.push(e),e.once(u.LOAD_COMPLETE,this.onLoaderComplete))}unregisterLoader(e){const t=this.loaders.indexOf(e);t>-1&&this.loaders.splice(t,1)}updateGlobalProgress(){const e=this.loaders.reduce(((e,t)=>e+t.progress),0)/this.loaders.length;this.emit(u.LOAD_PROGRESS,e)}}let T;const E=()=>(T||(T=new y),T),b=()=>{const e={};return{loader:null,assets:{},onInit(){},async onBeforeSetup(){E().expectLoader(e),this.assets||(this.assets={});const t=Object.entries(this.assets).filter((([e,t])=>null!=t)),s=m(t.map((([e,t])=>t)));this.loader=s,E().registerLoader(this.loader,this.constructor.name),s.on(u.LOAD_START,this.onLoadStart),s.on(u.LOAD_ERROR,this.onLoadError),s.on(u.LOAD_CANCELLED,this.onLoadCancelled),s.on(u.LOAD_START,this.onLoadStart),s.on(u.LOAD_PROGRESS,this.onLoadProgress),await s.load().then((e=>{e.forEach(((e,s)=>{const[o,r]=t[s];this.assets[o]=e}))}))},onSetup(){},onLoadStart(){},onLoadProgress(e){E().updateGlobalProgress()},onLoadError(){},onLoadComplete(){},onLoadCancelled(){},onDestroy(){this.loader&&(E().unregisterLoader(this.loader),this.loader.dispose(),this.loader.removeAllListeners()),E().unexpectLoader(e)}}};export{b as L,E as g};
